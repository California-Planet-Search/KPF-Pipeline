from modules.wavelength_cal.src.wavelength_cal import WaveCalibrate
from modules.Utils.string_proc import str_replace

output_dir = '/testdata/WLS/'
save_diagnostics_dir = None
quicklook = 1
f0 = config.ARGUMENT.f0_key
fr = config.ARGUMENT.frep_key
date_dir = '20230430'
cal_type = 'LFC'
#cal_type = 'ThAr'

master_wls_file = '/data/reference_fits/Th_new_WLS_102523_orders_0_10_green_SPH.fits'
full_master_wls = kpf1_from_fits(master_wls_file, data_type='KPF')

base_dir = '/data/L1/20230430/'
if cal_type == 'LFC':
    obj_string = 'KP.20230430.56774.47_L1.fits'
if cal_type == 'ThAr':
    obj_string = 'KP.20230430.63725.01_L1.fits'
L1_file = base_dir + obj_string
l1_obj = kpf1_from_fits(L1_file, data_type='KPF')
obj_string_short = str_replace(obj_string, '_L1.fits', '')

for ext in ['RED_SCI_WAVE2', 'GREEN_SCI_WAVE2']:
    master_wls = full_master_wls[ext]
    if ext == 'RED_SCI_WAVE2':
        CHIP = 'RED'
        linelist = config.ARGUMENT.red_linelist
        output_exts = config.ARGUMENT.red_output_ext
        orderlet_names = config.ARGUMENT.red_cal_orderlet_name
        min_order = config.ARGUMENT.red_min_order
        max_order = 1 #config.ARGUMENT.red_max_order
    if ext == 'GREEN_SCI_WAVE2':
        CHIP = 'GREEN'
        linelist = config.ARGUMENT.green_linelist
        output_exts = config.ARGUMENT.green_output_ext
        orderlet_names = config.ARGUMENT.green_cal_orderlet_name
        min_order = config.ARGUMENT.green_min_order
        max_order = 1 #config.ARGUMENT.green_max_order
    json_filename   = output_dir + date_dir + '/' + obj_string + '_WLS' + '_' + CHIP + '.json.gz'
        
    l1_obj = WaveCalibrate(
        l1_obj, cal_type, orderlet_names, True, quicklook, 
        min_order, max_order, 'KPF', output_exts,
        rough_wls = master_wls, f0_key=f0, frep_key=fr, output_dir = output_dir,
        linelist_path=linelist, save_diagnostics=save_diagnostics_dir, 
        json_filename=json_filename
    )

output_filename = output_dir + date_dir + '/' + obj_string + '_' + CHIP + '_WLS_L1.fits'
result = to_fits(l1_obj, output_filename)
