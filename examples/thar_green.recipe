from modules.wavelength_cal.src.wavelength_cal import WaveCalibrate

obs_num = 0

obsname = config.ARGUMENT.obs_prefix + config.ARGUMENT.obs_list[obs_num]
obsdate = config.ARGUMENT.obs_prefix[3] + config.ARGUMENT.obs_prefix[4] + config.ARGUMENT.obs_prefix[5] + config.ARGUMENT.obs_prefix[6] + config.ARGUMENT.obs_prefix[7] + config.ARGUMENT.obs_prefix[8] + config.ARGUMENT.obs_prefix[9] + config.ARGUMENT.obs_prefix[10]
L1_file = config.ARGUMENT.input_dir + obsdate + '/' + obsname + '.fits'
master_wls_file_green = config.ARGUMENT.master_wls_file_green + '.fits'
master_wls_green = kpf1_from_fits(master_wls_file_green, data_type='KPF')['GREEN_CAL_WAVE']
linelist_green = config.ARGUMENT.linelist_green

l1_obj = kpf1_from_fits(L1_file, data_type='KPF')

quicklook = config.ARGUMENT.quicklook

output_exts_green = config.ARGUMENT.output_ext_green
orderlet_names_green = config.ARGUMENT.cal_orderlet_name_green
save_diagnostics = config.ARGUMENT.save_diagnostics + obsdate + '/' + config.ARGUMENT.obs_list[obs_num] + '/'
output_dir = config.ARGUMENT.output_dir + obsdate + '/'
 
wave_soln = WaveCalibrate(
    l1_obj, 'ThAr', orderlet_names_green, True, quicklook, 'KPF', output_exts_green,
    rough_wls = master_wls_green, 
    output_dir = output_dir, linelist_path=linelist_green, save_diagnostics=save_diagnostics, 
)

output_filename = output_dir + obsname + config.ARGUMENT.lev1_suffix + '.fits'
result = to_fits(wave_soln, output_filename)