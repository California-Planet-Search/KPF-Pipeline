from modules.flat_fielding.src.flat_fielding import FlatFielding
from modules.Utils.frame_combine import FrameCombinePrimitive

#kpfsim
#flat_files_path = KPFPIPE_TEST_DATA
lev0_ffi_exts = ['GREEN_CCD','RED_CCD']
master_flat_path = '/Users/paminabby/Desktop/end_to_end/test_zeros_masterbias.fits'
L0_files_path = KPFPIPE_TEST_DATA+'/KPF-Pipeline-TestData/KPF_Simulated_Data/L0_data_format_w_headers_20211001.fits'
new_raw_file = './examples/V1/FlatRecipe/FlatRecipeRes/end_flat_kpfsim_test.fits'
master_flat_create = False

#all_flat_files = find_files(flat_files_path)
if master_flat_create == True:
    master_flat_data = FrameCombinePrimitive(all_flat_files,lev0_ffi_exts,'NEID')
    master_flat_result = to_fits(master_flat_data,master_flat_path)
if master_flat_create == False:
    master_flat_data = find_files(master_flat_path)

for raw_file in find_files(L0_files_path):
    raw_file = kpf0_from_fits(raw_file)
    final_raw_frames_file = FlatFielding(raw_file,master_flat_data,lev0_ffi_exts,'NEID')
    result = to_fits(final_raw_frames_file, new_raw_file)

