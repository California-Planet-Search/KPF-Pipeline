

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>kpfpipe.models.data_model &mdash; KPFPipeline 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> KPFPipeline
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/start.html">KPF Pipeline Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../primitives/primitives.html">Implemented Primitives</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">KPFPipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>kpfpipe.models.data_model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for kpfpipe.models.data_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Data models for KPF data</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Standard dependencies</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span> 
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># External dependencies</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">git</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># Pipeline dependencies</span>
<span class="kn">from</span> <span class="nn">kpfpipe.models.metadata.receipt_columns</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="KPFDataModel"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel">[docs]</a><span class="k">class</span> <span class="nc">KPFDataModel</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;The base class for all KPF data models.</span>

<span class="sd">    Warning: </span>
<span class="sd">        This class (KPFDataModel) should not be used directly.</span>
<span class="sd">        Based on the data level of your .fits file, used the appropriate data model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        header (dict): a dictionary of headers of each extension (HDU)</span>

<span class="sd">            Header stores all header information from the FIT file. Since Each file is</span>
<span class="sd">            organized into extensions (HDUs), and Astropy parses each extension&#39;s </span>
<span class="sd">            header cards into a dictionary, this attribute is structured as a dictionary</span>
<span class="sd">            of dictionaries. The first layer is the name of the header, and the second layer </span>
<span class="sd">            is the name of the key.</span>
<span class="sd">            </span>
<span class="sd">            Note: </span>
<span class="sd">                For KPF, FITS extensions are identified by their name</span>

<span class="sd">            Examples</span>
<span class="sd">                &gt;&gt;&gt; from kpfpipe.models.level0 import KPF0</span>
<span class="sd">                # Assume we have an NEID level 0 file called &quot;level0.fits&quot;</span>
<span class="sd">                &gt;&gt;&gt; level0 = KPF0.from_fits(&#39;level0.fits&#39;, &#39;NEID&#39;)</span>
<span class="sd">                # Accessing key &#39;OBS_TIME&#39; from the &#39;PRIMARY&#39; HDU</span>
<span class="sd">                &gt;&gt;&gt; obs_time = level0.header[&#39;PRIMARY&#39;][&#39;OBS_TIME&#39;] </span>

<span class="sd">        receipt (pandas.DataFrame): a table that records the history of this data</span>

<span class="sd">            The receipt keeps track of the data process history, so that the information</span>
<span class="sd">            stored by this instance can be reproduced from the original data. It is </span>
<span class="sd">            structured as a pandas.DataFrame table, with each row as an entry</span>

<span class="sd">            Primitives that modifies the content of a data product are expected to also </span>
<span class="sd">            write to the receipt. Three string inputs from the primitive are required: name, </span>
<span class="sd">            any relevant parameters, and a status. The receipt will also automatically fill </span>
<span class="sd">            in additional information, such as the time of execution, code release version, </span>
<span class="sd">            current branch, ect. </span>

<span class="sd">            Note: </span>
<span class="sd">                It is not recommended to modify the Dataframe directly. Use the provided methods</span>
<span class="sd">                to make any adjustments.</span>

<span class="sd">            Examples:</span>
<span class="sd">                &gt;&gt;&gt; from kpfpipe.models.level0 import KPF0</span>
<span class="sd">                &gt;&gt;&gt; data = KPF0()</span>
<span class="sd">                # Add an entry into the receipt</span>
<span class="sd">                # Three args are required: name_of_primitive, param, status</span>
<span class="sd">                &gt;&gt;&gt; data.receipt_add_entry(&#39;primitive1&#39;, &#39;param1&#39;, &#39;PASS&#39;)</span>
<span class="sd">                &gt;&gt;&gt; data.receipt</span>
<span class="sd">                                        Time     ...  Module_Param Status</span>
<span class="sd">                0  2020-06-22T15:42:18.360409     ...        input1   PASS</span>

<span class="sd">        extension (dict): a dictionary of auxiliary extensions.</span>

<span class="sd">            This attribute stores any additional information that any primitive may wish to </span>
<span class="sd">            record to FITS. Creating an auxiliary creates an empty pandas.DataFrame table, and</span>
<span class="sd">            one may modify it directly. Creating an auxiliary will also create a new key-value </span>
<span class="sd">            in header, so that one can write header keywords to the extension. When writing to</span>
<span class="sd">            FITS, Auxiliary extensions are stored as binary tables.</span>

<span class="sd">            Examples:</span>
<span class="sd">                &gt;&gt;&gt; from kpfpipe.models.level0 import KPF0</span>
<span class="sd">                &gt;&gt;&gt; data = KPF0()</span>
<span class="sd">                # Add an auxiliary extension</span>
<span class="sd">                # A unique name is required</span>
<span class="sd">                &gt;&gt;&gt; data.create_extension(&#39;extension 1&#39;)</span>
<span class="sd">                # Access the extension by using its name as the dict key</span>
<span class="sd">                # Add a column called &#39;col1&#39; to the Dataframe</span>
<span class="sd">                &gt;&gt;&gt; data.extension[&#39;extension 1&#39;][&#39;col1&#39;] = [1, 2, 3]</span>
<span class="sd">                &gt;&gt;&gt; data.extension[&#39;extension 1&#39;]</span>
<span class="sd">                col1</span>
<span class="sd">                0     1</span>
<span class="sd">                1     2</span>
<span class="sd">                2     3</span>
<span class="sd">                # add a key-value pair to the header</span>
<span class="sd">                &gt;&gt;&gt; data.header[&#39;extension 1&#39;][&#39;key&#39;] = &#39;value&#39;</span>
<span class="sd">                # delete the extension we just made</span>
<span class="sd">                &gt;&gt;&gt; data.del_extension[&#39;extension 1&#39;]</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">:</span> <span class="p">{},</span> 
                             <span class="s1">&#39;RECEIPT&#39;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="c1"># Construct the receipt table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receipt</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">RECEIPT_COL</span><span class="p">)</span>

        <span class="c1"># list of auxiliary extensions </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># I/O related methods</span>
<div class="viewcode-block" id="KPFDataModel.from_fits"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.from_fits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a data instance from a file</span>

<span class="sd">        Args: </span>
<span class="sd">            fn (str): file path (relative to the repository)</span>
<span class="sd">            data_type (str): instrument type of the file</span>
<span class="sd">            </span>
<span class="sd">        Returns: </span>
<span class="sd">            cls (data model class): the data instance containing the file content</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">this_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="c1"># populate it with self.read()</span>
        <span class="n">this_data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>
        <span class="c1"># Return this instance</span>
        <span class="k">return</span> <span class="n">this_data</span></div>

<div class="viewcode-block" id="KPFDataModel.read"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read the content of a .fits file and populate this </span>
<span class="sd">        data structure. </span>

<span class="sd">        Args: </span>
<span class="sd">            fn (str): file path (relative to the repository)</span>
<span class="sd">            data_type (str): instrument type of the file</span>
<span class="sd">            overwrite (bool): if this instance is not empty, specifies whether to overwrite</span>

<span class="sd">        Note:</span>
<span class="sd">            This is not a @classmethod so initialization is </span>
<span class="sd">            required before calling this function</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
            <span class="c1"># Can only read .fits files</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;input files must be FITS files&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># This instance already contains data, and</span>
            <span class="c1"># we don&#39;t want to overwrite </span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Cannot overwrite existing data&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu_list</span><span class="p">:</span>
            <span class="c1"># Handles the Receipt and the auxilary HDUs </span>
            <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdu_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RECEIPT&#39;</span><span class="p">:</span>
                        <span class="c1"># Table contains the RECEIPT</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RECEIPT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">receipt</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;AUX&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AUX&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="c1"># This is an auxiliary extension</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="c1"># Leave the rest of HDUs to level specific readers</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_methods</span><span class="p">[</span><span class="n">data_type</span><span class="p">](</span><span class="n">hdu_list</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># the provided data_type is not recognized, ie.</span>
                <span class="c1"># not in the self.read_methods list</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;cannot recognize data type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="KPFDataModel.to_fits"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.to_fits">[docs]</a>    <span class="k">def</span> <span class="nf">to_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect the content of this instance into a monolithic FITS file</span>

<span class="sd">        Args: </span>
<span class="sd">            fn (str): file path</span>

<span class="sd">        Note:</span>
<span class="sd">            Can only write to KPF formatted FITS </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
            <span class="c1"># we only want to write to a &#39;.fits file</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;filename must ends with .fits&#39;</span><span class="p">)</span>    

        <span class="n">gen_hdul</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_create_hdul&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gen_hdul</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Write method not found. Is this the base class?&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">gen_hdul</span><span class="p">()</span>
        
        <span class="c1"># handles receipt</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receipt</span><span class="p">)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RECEIPT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;RECEIPT&#39;</span>
        <span class="n">hdu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="c1"># handles any auxiliary extensions</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">hdu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="c1"># check that no card in any HDU is greater than 80</span>
        <span class="c1"># this is a hard limit by FITS </span>
        <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdu_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;OBS FILE&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBS FILE&#39;</span><span class="p">]</span>

        <span class="c1"># finish up writing</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">)</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1"># =============================================================================</span>
<span class="c1"># Receipt related members</span>
<div class="viewcode-block" id="KPFDataModel.receipt_add_entry"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.receipt_add_entry">[docs]</a>    <span class="k">def</span> <span class="nf">receipt_add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mod</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add an entry to the receipt</span>

<span class="sd">        Args:</span>
<span class="sd">            Mod (str): Name of the module making this entry</span>
<span class="sd">            param (str): param to be recorded</span>
<span class="sd">            status (str): status to be recorded</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># time of execution in ISO format</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="c1"># get version control info (git)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="n">search_parent_directories</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">git_commit_hash</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">hexsha</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">active_branch</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># add the row to the bottom of the table</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="n">git_branch</span><span class="p">,</span> <span class="n">git_commit_hash</span><span class="p">,</span> \
               <span class="n">Mod</span><span class="p">,</span> <span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">status</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receipt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receipt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">row</span></div>

<div class="viewcode-block" id="KPFDataModel.receipt_info"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.receipt_info">[docs]</a>    <span class="k">def</span> <span class="nf">receipt_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Print the short version of the receipt</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receipt</span><span class="p">[[</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Module_Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">]])</span></div>

<span class="c1"># =============================================================================</span>
<span class="c1"># Auxiliary related extension</span>
<div class="viewcode-block" id="KPFDataModel.create_extension"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.create_extension">[docs]</a>    <span class="k">def</span> <span class="nf">create_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create an Auxiliary extension to be saved to FITS </span>

<span class="sd">        Args:</span>
<span class="sd">            ext_name (str): extension name</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># check whether the extension already exist</span>
        <span class="k">if</span> <span class="n">ext_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;name </span><span class="si">{}</span><span class="s1"> already exist as extension&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext_name</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="n">ext_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">ext_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AUX&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span></div>
    
<div class="viewcode-block" id="KPFDataModel.del_extension"><a class="viewcode-back" href="../../../api/datamodel.html#kpfpipe.models.data_model.KPFDataModel.del_extension">[docs]</a>    <span class="k">def</span> <span class="nf">del_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete an existing auxiliary extension</span>

<span class="sd">        Args:</span>
<span class="sd">            ext_name (str): extension name</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ext_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;extension </span><span class="si">{}</span><span class="s1"> could not be found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext_name</span><span class="p">))</span>
        
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="n">ext_name</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">ext_name</span><span class="p">]</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Arpita Roy, BJ Fulton, Andrew Howard

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>